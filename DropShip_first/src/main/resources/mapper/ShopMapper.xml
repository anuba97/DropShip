<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.java.mapper.ShopMapper">

	<!--//////////////////       ↓  Work(작품) 관련 ↓         /////////////////////////  -->
	
	<!-- 작품 그림작품 가져오기 -->
	<select id="selectWorkList" resultType="com.java.vo.WorkVo">
		SELECT * FROM (SELECT ROWNUM rnum, a.* FROM 
		(SELECT w.id AS id, work_name, w.artist_id, work_img_url, work_price, a.artist_korean_name as artist_name
		FROM Work w JOIN Artist a ON w.artist_id = a.id ORDER BY artist_id asc) a)
		WHERE rnum BETWEEN #{startRow} AND #{endRow}
		
		<!-- SELECT w.id AS id, work_name, w.artist_id, work_img_url, work_price, a.artist_korean_name AS artist_name  
		FROM Work w JOIN Artist a ON w.artist_id = a.id
		ORDER BY Artist_id ASC -->
	</select>
	
	<!-- 작품 갯수 확인 -->
	<select id="selectWorkCount" resultType="int">
		SELECT COUNT(*) count FROM work
	</select>
	
	<!-- 작품 베스트 가져오기 -->
	<select id="selectWorkBest" resultType="com.java.vo.WorkVo">
		SELECT w.id AS id, w.work_name, w.work_img_url ,a.artist_korean_name AS artist_name, w.artist_id, 
				w.work_price 
		FROM Work w
		JOIN Artist a ON w.artist_id = a.id
		WHERE work_isBest = 1
	</select>
	
	<!-- 작품 new 가져오기 -->
	<select id="selectWorkNew" resultType="com.java.vo.WorkVo">
		SELECT * FROM (SELECT rownum rnum, n.* FROM 
		(SELECT w.id AS id, work_name, artist_id, a.artist_korean_name AS artist_name, work_img_url, work_content, work_reg_date
		FROM Work w JOIN Artist a
		on w.artist_id = a.id
		ORDER BY work_reg_date DESC) n )
		WHERE rnum between 1 and 5
	</select>
	
	<!-- 작품(구매창) 1개 가져오기 -->
	<select id="selectWorkBuy" resultType="com.java.vo.WorkVo">
		SELECT * FROM (
	        SELECT w.id AS id, w.work_name, a.id AS artist_id, 
	        	   w.work_genre, w.work_subject, w.work_img_url, w.work_content, w.work_sale, w.work_isBest,
			       w.work_reg_date, w.work_price, w.work_display_position, w.work_hit, w.admin_id, work_available,
			       a.artist_korean_name AS artist_name
	        FROM Work w
	        JOIN Artist a ON w.artist_id = a.id
        ) 
   	    WHERE id = #{work_id}
	</select>
	
	<!-- 작가의 작품들 가져오기 -->
	<select id="selectWorkArtistAll" resultType="com.java.vo.WorkVo">
		SELECT w.id AS id, work_name, artist_id, a.artist_korean_name AS artist_name,
				work_img_url, work_price, work_hit  
		FROM Work w
		JOIN Artist a ON w.artist_id = a.id
		WHERE w.artist_id = #{artist_id}
		ORDER BY work_hit DESC
	</select>  
	
	
	<!--//////////////////       ↓  Artist(작가)관련 ↓         /////////////////////////  -->
	
	<!-- 작가 전체 가져오기 -->
	<select id="selectArtistAll" resultType="com.java.vo.ArtistVo">
		SELECT * FROM artist WHERE id = #{artist_id} 
	</select>
	
	<!-- 작가 총 갯수 -->
	<select id="selectArtistCount" resultType="int">
		SELECT COUNT(*) count FROM artist 
	</select>
	
	<!-- index에서 작가별 작가페이지 작가 가져오기 -->
	<select id="selectArtistList" resultType="com.java.vo.ArtistVo">
		SELECT * FROM (SELECT rownum rnum, a.* FROM 
		(SELECT id, artist_korean_name, artist_english_name, artist_img_url 
		FROM artist ORDER BY id asc) a)
		WHERE rnum BETWEEN #{startRow} AND #{endRow}
	</select>
	
	
	<!--//////////////////       ↓  order(주문)관련 ↓         /////////////////////////  -->
	
	<!-- 작품 1개 가져오기 (주문할때 사용)-->
	<select id="selectWorkOneOrder" resultType="com.java.vo.WorkVo">
		SELECT w.id AS id, w.work_name, w.work_img_url ,a.artist_korean_name AS artist_name, 
				w.work_price, w.artist_id
		FROM Work w
		JOIN Artist a ON w.artist_id = a.id
		WHERE w.id = #{id}
	</select>
	
	
	<!-- 주문 저장 전 배송 데이터 저장  -->
	<insert id="insertDelivery">  
	  	INSERT INTO Delivery (id, delivery_start, delivery_end)
		VALUES (Delivery_SEQ.NEXTVAL, sysdate+1, sysdate+3)
  	</insert>
  	
  	<select id="selectDeliverySeq" resultType="int">
  		SELECT DELIVERY_SEQ.CURRVAL FROM DUAL
  	</select>
	
	
	<insert id="insertDelivery2">
	    <selectKey resultType="int" keyProperty="id" order="AFTER">
	        SELECT Delivery_SEQ.currval FROM dual
	    </selectKey>
	    INSERT INTO Delivery (id, delivery_start, delivery_end)
		VALUES (Delivery_SEQ.nextval, sysdate+1, sysdate+3)
	</insert>
	
	
	
	
	
	
	<!-- 회원 주문 저장  -->
<!-- 	<insert id="insertOrder_Member">   -->
<!-- 	  	INSERT INTO Order_Member (id, member_id, order_date, order_status, delivery_id, delivery_name,  -->
<!-- 	  	delivery_phone, delivery_zip, delivery_road, delivery_address, delivery_request) -->
<!-- 		VALUES (Order_Member_SEQ.NEXTVAL, #{member_id}, SYSDATE, 0, #{delivery_id}, #{delivery_name},  -->
<!-- 		#{delivery_phone}, #{delivery_zip}, #{delivery_road}, #{delivery_address}, #{delivery_request}) -->
<!--   	</insert> -->
  	
  	
  	<insert id="insertOrder_Member2" >
	    <selectKey resultType="int" keyProperty="order_memberVo.id" order="BEFORE">  <!-- keyProperty를 원랜 id만 적어도 넘어온 vo의 id인스턴수 변수를 찾을 수 있는데 인자로 여러개 넘어오면 이렇게 뭐의 id인지 지정해줘야.  -->
	        SELECT Order_Member_SEQ.nextval FROM dual
	    </selectKey>
	    INSERT INTO Order_Member (id, member_id, order_date, order_status, delivery_id, delivery_name, 
		  	delivery_phone, delivery_zip, delivery_road, delivery_address, delivery_request)
			VALUES (#{order_memberVo.id}, #{member_id}, SYSDATE, 0, #{delivery_id}, #{order_memberVo.delivery_name}, 
			#{order_memberVo.delivery_phone}, #{order_memberVo.delivery_zip}, #{order_memberVo.delivery_road}, #{order_memberVo.delivery_address}, #{order_memberVo.delivery_request})
	</insert>
  	
  	
  	
  	
  	
  	
  	<!-- 회원 주문 저장 후 order_member_seq.currval(회원 주문 고유번호) 가져오기 -->
	<select id="selectOrderMemberSeq" resultType="int">
		SELECT Order_Member_SEQ.CURRVAL FROM DUAL
	</select>
	
	<!-- 작품 옵션 저장 후 Work_Option_SEQ.CURRVAL(작품 옵션 고유번호) 가져오기 -->
  	<insert id="insertOption" parameterType="com.java.vo.OptionVo">
	    <selectKey resultType="int" keyProperty="id" order="BEFORE">
	        SELECT work_option_seq.nextval FROM dual
	    </selectKey>
	    INSERT INTO work_option VALUES (#{id}, #{option_size}, #{option_size_added_price}, 
		    #{option_media}, #{option_media_price_multiple}, #{option_mattier}, #{option_frame}, #{option_frame_added_price}, 
		    #{option_matt}, #{option_matt_added_price}, #{option_quantity}, #{option_selected_price})
	</insert>
	
	
	<!-- 회원 주문 객체 가져오기(주문 결과 띄우기용) -->
	<select id="selectOrderMemberOne_result" resultType="com.java.vo.Order_MemberVo">
		SELECT * FROM Order_Member WHERE id = #{order_member_id}
	</select>
	
	<!-- 회원 주문상세 저장 (작품상세페이지에서만 넘어왔을 때)  -->
	<insert id="insertOrder_Detail">
		 INSERT INTO Order_Detail (id, order_member_id, work_id, option_id, total_price, 
		 							event_work_sale, event_period_sale, final_price)
		 VALUES (Order_Detail_SEQ.NEXTVAL, #{order_member_id}, #{work_id}, #{option_id}, #{total_price}, 
		 		0, 0, #{total_price})	<!-- 마지막  #{total_price}는 원랜 final_price가 되어야 함. 근데 할인 구현 안하고있으니까 그냥 total_price로 넣음 -->
	</insert>
	
	
	
<!-- 	회원 주문상세 저장 (cart에서 주문할때도 가능하게)  -->
<!-- 	<insert id="insertOrder_Details" parameterType="java.util.List"> -->
<!-- 	    INSERT ALL -->
<!-- 	    <foreach collection="workIdList" item="workId" index="index" separator=" "> -->
<!-- 	        INTO order_detail (id, order_member_id, work_id, option_id, total_price, -->
<!-- 	        				event_work_sale, event_period_sale, final_price) -->
<!-- 	        VALUES (Order_Detail_SEQ.NEXTVAL, #{order_member_id}, #{workId}, #{optionIdList[${index}]}, #{total_price},  -->
<!-- 	        0, 0, #{total_price}) -->
<!-- 	    </foreach> -->
<!-- 	    SELECT * FROM DUAL -->
<!-- 	</insert> -->
	
	
	
	
	<!-- 회원 마이페이지주문조회  -->
	  <select id="selectOrderDetailByMemberId" resultType="com.java.vo.Order_Detail_inquireVo">
	    SELECT om.order_date, od.order_member_id, w.work_img_url, w.work_name, a.artist_korean_name, 
	    	   wo.option_quantity, wo.option_selected_price, om.order_status
			FROM order_detail od
			JOIN order_member om ON od.order_member_id = om.id
			JOIN work w ON od.work_id = w.id
			JOIN artist a ON w.artist_id = a.id
			JOIN work_option wo ON od.option_id = wo.id
		WHERE member_id = #{member_id}
		ORDER BY om.order_date DESC
	  </select>
	  
	  
	<!-- 회원 마이페이지주문 상세조회  -->
	  <select id="selectOptionOneInquiryView" resultType="com.java.vo.Order_Detail_inquire_viewVo">
	    SELECT om.id, om.order_date, om.delivery_name, om.delivery_phone, om.delivery_zip, om.delivery_road, om.delivery_address, om.delivery_request,
		       wo.option_size, wo.option_size_added_price, wo.option_media, wo.option_media_price_multiple, wo.option_mattier, wo.option_frame,
		       wo.option_frame_added_price, wo.option_matt, wo.option_matt_added_price, wo.option_quantity, wo.option_selected_price,
		       a.artist_korean_name,
		       w.work_name, w.work_price, w.work_img_url, w.id AS work_id,
		       m.member_name, m.member_phone, m.member_zip, m.member_road, m.member_addr, m.member_email
		FROM Order_Member om
		JOIN Order_Detail od ON om.id = od.order_member_id
		JOIN Work_Option wo ON od.option_id = wo.id
		JOIN Work w ON od.work_id = w.id
		JOIN Artist a ON w.artist_id = a.id
		JOIN Member m ON om.member_id = m.id
		WHERE om.id = #{order_member_id}
	  </select>
	<!-- 위 방식은 무식하게 조인으로 한번에 하는 방식. 편하고 성능 좋아  -->
	
	<!-- 아래 방식은 조인 적게하는 대신 여러번 걸쳐서 가져오는 방식. 유지보수/확장성 장점  -->
	<!--  회원 주문 상세 객체 리스트를 받아옴 -->
	  <select id="selectOrderDetail" resultType="com.java.vo.Order_DetailVo">
	  	SELECT work_id, option_id 
	  	FROM order_detail 
	  	WHERE order_member_id = #{order_member_id}
	  </select>
	  
	  <!-- 회원 주문 상세/ 회원 장바구니 조희용 option객체들 가져오기 -->
<!-- 	  <select id="selectOptionList" resultType="com.java.vo.OptionVo"> -->
<!-- 	  	SELECT * FROM work_option WHERE id IN ( -->
<!--             <foreach collection="optionIdList" item="optionId" separator=","> -->
<!--                 #{optionId} -->
<!--             </foreach> -->
<!--         ) ORDER BY id DESC -->
<!-- 	  </select> -->
	  
	  
	  
	  <select id="selectOptionList" resultType="com.java.vo.OptionVo">
		    <if test="optionIdList != null and optionIdList.size() > 0">
		        SELECT * FROM work_option WHERE id IN (
		            <foreach collection="optionIdList" item="optionId" separator=",">
		                #{optionId}
		            </foreach>
		        ) ORDER BY id DESC
		    </if>
	  </select>
	  
	  
	  
	  
	  
	  <!-- 회원 주문 상세용 work객체들 가져오기 -->
	  <select id="selectMemberWorkList" resultType="com.java.vo.WorkVo">
	  	SELECT * FROM work WHERE id IN (
            <foreach collection="workIdList" item="workId" separator=",">
                #{workId}
            </foreach>
        ) ORDER BY id DESC
	  </select>
	  
	  <!-- 회원 주문 상세용 Artist객체들 가져오기 -->
	  <select id="selectArtistOrderList" resultType="com.java.vo.ArtistVo">
	  	SELECT artist_korean_name FROM artist WHERE id IN (
            <foreach collection="artistIdList" item="artistId" separator=",">
                #{artistId}
            </foreach>
        ) ORDER BY id DESC
	  </select>
	  
	  <!-- 회원 장바구니 저장  -->
	 <insert id="insertCart_Member">
	 	 INSERT INTO Cart_Member
		 VALUES (CART_MEMBER_SEQ.NEXTVAL, #{member_id}, #{work_id}, #{option_id}, sysdate)
	 </insert>
	  
	  
	  <!-- 회원 장바구니 가져오기 -->
	 <select id="selectCart_MemberList" resultType="com.java.vo.Cart_MemberVo">
	  	SELECT * FROM Cart_Member WHERE member_id = #{member_id} ORDER BY added_date desc
     </select>
			 
			
			
</mapper>